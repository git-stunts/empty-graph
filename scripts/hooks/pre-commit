#!/bin/sh
# IRONCLAD M9 — pre-commit gate.
# Runs ESLint on staged JS files AND the full TS policy checker.
# NOTHING commits if either gate fails.

set -e

ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$ROOT" ]; then
  echo "pre-commit: unable to locate repo root" >&2
  exit 1
fi
cd "$ROOT"

# ── Gate 1: ESLint on staged JS files ──────────────────────────────────────

# Get staged JS files using NUL-delimited output for safe filename handling
# This handles filenames with spaces, special characters, or starting with '-'
# Store NUL-delimited list in a temp file to avoid running git twice
TMPFILE=$(mktemp)
trap 'rm -f "$TMPFILE"' EXIT

git diff --cached --name-only --diff-filter=ACM -z | grep -zE '\.(js|mjs|cjs)$' > "$TMPFILE"

# Check if there are any JS files to lint (file will be empty if none)
if [ -s "$TMPFILE" ]; then
  echo "[IRONCLAD] Running ESLint on staged files..."
  xargs -0 npx eslint --no-warn-ignored -- < "$TMPFILE"
  echo "[IRONCLAD] ESLint passed."
fi

# ── Gate 2: TS policy checker (full scan) ──────────────────────────────────
# Catches: any in JSDoc, * wildcards, @ts-ignore, z.any(), TODO(ts-cleanup)
# Scans ALL source files, not just staged — prevents partial-commit evasion.

echo "[IRONCLAD] Running TS policy check..."
node scripts/ts-policy-check.js
echo "[IRONCLAD] All gates passed."
