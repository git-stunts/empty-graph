#!/bin/sh
# ═══════════════════════════════════════════════════════════════════════════
# IRONCLAD M9 — pre-push gate
#
# Five gates in parallel, then unit tests. ALL must pass or push is blocked.
# This is the last local line of defense before CI.
# ═══════════════════════════════════════════════════════════════════════════
set -e

ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$ROOT" ]; then
  echo "pre-push: unable to locate repo root" >&2
  exit 1
fi
cd "$ROOT"

# ── Quick mode: skip unit tests when WARP_QUICK_PUSH=1 or true ──────────
QUICK=0
if [ "$WARP_QUICK_PUSH" = "1" ] || [ "$WARP_QUICK_PUSH" = "true" ]; then
  QUICK=1
  echo "WARP_QUICK_PUSH: quick mode active — Gate 5 (unit tests) will be skipped"
fi

echo "══════════════════════════════════════════════════════════"
echo "  IRONCLAD M9 — pre-push type firewall"
echo "══════════════════════════════════════════════════════════"

# ── Link check (optional) ──────────────────────────────────────────────────
if command -v lychee >/dev/null 2>&1; then
  echo "[Gate 0] Link check..."
  lychee --config .lychee.toml '**/*.md'
else
  echo "[Gate 0] Link check skipped (lychee not installed)"
fi

# ── Gates 1-4 in parallel (all are read-only) ─────────────────────────────
echo "[Gates 1-4] Running lint + typecheck + policy + consumer type test..."

npm run lint &
LINT_PID=$!
npm run typecheck &
TC_PID=$!
npm run typecheck:policy &
POLICY_PID=$!
npm run typecheck:consumer &
CONSUMER_PID=$!

wait $LINT_PID    || { echo ""; echo "BLOCKED — Gate 1 FAILED: ESLint (includes no-explicit-any, no-unsafe-*)"; exit 1; }
wait $TC_PID      || { echo ""; echo "BLOCKED — Gate 2 FAILED: TypeScript compiler (strict mode)"; exit 1; }
wait $POLICY_PID  || { echo ""; echo "BLOCKED — Gate 3 FAILED: IRONCLAD policy (any/wildcard/ts-ignore ban)"; exit 1; }
wait $CONSUMER_PID || { echo ""; echo "BLOCKED — Gate 4 FAILED: Consumer type surface test"; exit 1; }

echo "[Gates 1-4] All type gates passed."

# ── Gate 5: Unit tests ─────────────────────────────────────────────────────
if [ "$QUICK" = "1" ]; then
  echo "[Gate 5] Skipped (WARP_QUICK_PUSH quick mode)"
else
  echo "[Gate 5] Running unit tests..."
  npm run test:local
fi

echo "══════════════════════════════════════════════════════════"
echo "  IRONCLAD M9 — all gates passed. Push authorized."
echo "══════════════════════════════════════════════════════════"

# Docker builds, benchmarks, and BATS E2E tests run in CI only
