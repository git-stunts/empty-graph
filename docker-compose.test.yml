# Multi-runtime test matrix.
#
# Usage:
#   docker compose -f docker-compose.test.yml --profile node22 up --build   # Node 22 only
#   docker compose -f docker-compose.test.yml --profile full up --build     # All runtimes
#
# Profiles:
#   node20  — Node 20 (unit + integration + BATS CLI)
#   node22  — Node 22 (unit + integration + BATS CLI)
#   bun     — Bun (API integration only)
#   deno    — Deno (API integration only)
#   full    — All four runtimes in parallel

services:
  # Node 20 (LTS maintenance): unit + API integration + BATS CLI
  test-node20:
    build:
      context: ..
      dockerfile: git-warp/docker/Dockerfile.node20
    environment:
      - GIT_STUNTS_DOCKER=1
    command: ["sh", "-c", "npx vitest run test/unit test/integration && bats test/bats/"]
    profiles: [node20, full]

  # Node 22 (LTS active): unit + API integration + BATS CLI
  test-node22:
    build:
      context: ..
      dockerfile: git-warp/docker/Dockerfile.node22
    environment:
      - GIT_STUNTS_DOCKER=1
    command: ["sh", "-c", "npx vitest run test/unit test/integration && bats test/bats/"]
    profiles: [node22, full]

  # Bun: API integration tests only (CLI is Node-only)
  test-bun:
    build:
      context: ..
      dockerfile: git-warp/docker/Dockerfile.bun
    environment:
      - GIT_STUNTS_DOCKER=1
    command: ["bunx", "vitest", "run", "test/integration/api/"]
    profiles: [bun, full]

  # Deno: API integration tests via Deno.test() wrappers
  test-deno:
    build:
      context: ..
      dockerfile: git-warp/docker/Dockerfile.deno
    environment:
      - GIT_STUNTS_DOCKER=1
    command: ["deno", "test", "--allow-all", "--node-modules-dir", "test/runtime/deno/"]
    profiles: [deno, full]
