digraph BitmapIndex {
    // Graph settings
    rankdir=LR;
    splines=ortho;
    nodesep=0.4;
    ranksep=1.2;
    bgcolor="white";
    fontname="Helvetica";
    compound=true;

    // Node defaults
    node [
        fontname="Helvetica",
        fontsize=10,
        style="filled",
        penwidth=1.5
    ];

    // Edge defaults
    edge [
        fontname="Helvetica",
        fontsize=8,
        penwidth=1.5
    ];

    // Title
    labelloc="t";
    label=<<b>Roaring Bitmap Index: O(1) Graph Traversal</b><br/><font point-size="10">SHA → ID mapping + bitmap sets for edges</font>>;
    fontsize=14;

    // === GRAPH CLUSTER ===
    subgraph cluster_graph {
        label="Event Graph";
        style=rounded;
        color="#1976d2";
        bgcolor="#e3f2fd";
        fontsize=11;

        node [shape=circle, width=0.6, fillcolor="#bbdefb", color="#1565c0"];

        A [label="A"];
        B [label="B"];
        C [label="C"];
        D [label="D"];

        A -> B [color="#1565c0"];
        A -> C [color="#1565c0"];
        B -> D [color="#1565c0"];
        C -> D [color="#1565c0"];
    }

    // === ID MAPPING CLUSTER ===
    subgraph cluster_ids {
        label="SHA → Numeric ID";
        style=rounded;
        color="#7b1fa2";
        bgcolor="#f3e5f5";
        fontsize=11;

        node [shape=record, fillcolor="#e1bee7", color="#7b1fa2"];

        ids [label="{ a1b2c3... | 0 } | { b2c3d4... | 1 } | { c3d4e5... | 2 } | { d4e5f6... | 3 }"];
    }

    // === FORWARD INDEX ===
    subgraph cluster_fwd {
        label="Forward Index (children)";
        style=rounded;
        color="#388e3c";
        bgcolor="#e8f5e9";
        fontsize=11;

        node [shape=record, fillcolor="#c8e6c9", color="#388e3c"];

        fwd_a [label="{ A (id=0) | bitmap\{1,2\} }"];
        fwd_b [label="{ B (id=1) | bitmap\{3\} }"];
        fwd_c [label="{ C (id=2) | bitmap\{3\} }"];
        fwd_d [label="{ D (id=3) | bitmap\{\} }"];
    }

    // === REVERSE INDEX ===
    subgraph cluster_rev {
        label="Reverse Index (parents)";
        style=rounded;
        color="#e65100";
        bgcolor="#fff3e0";
        fontsize=11;

        node [shape=record, fillcolor="#ffe0b2", color="#e65100"];

        rev_a [label="{ A (id=0) | bitmap\{\} }"];
        rev_b [label="{ B (id=1) | bitmap\{0\} }"];
        rev_c [label="{ C (id=2) | bitmap\{0\} }"];
        rev_d [label="{ D (id=3) | bitmap\{1,2\} }"];
    }

    // === QUERY EXAMPLE ===
    subgraph cluster_query {
        label="Query: getChildren(A)";
        style=rounded;
        color="#c62828";
        bgcolor="#ffebee";
        fontsize=11;

        node [shape=box, style="filled,rounded", fillcolor="#ffcdd2", color="#c62828"];

        q1 [label="1. Lookup A's ID → 0"];
        q2 [label="2. Load fwd shard"];
        q3 [label="3. Get bitmap\{1,2\}"];
        q4 [label="4. Map to [B, C]"];
        q5 [label="O(1) result!", shape=oval, fillcolor="#c8e6c9", color="#388e3c"];

        q1 -> q2 -> q3 -> q4 -> q5 [color="#c62828"];
    }

    // Cross-cluster edges
    A -> ids [style=dashed, color="#7b1fa2", lhead=cluster_ids, ltail=cluster_graph];
    ids -> fwd_a [style=dashed, color="#388e3c", lhead=cluster_fwd];
    ids -> rev_a [style=dashed, color="#e65100", lhead=cluster_rev];
}
